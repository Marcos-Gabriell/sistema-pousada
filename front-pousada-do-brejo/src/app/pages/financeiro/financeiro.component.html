<div
  class="p-4 sm:p-6 w-full max-w-5xl 2xl:max-w-6xl mx-auto flex flex-col items-center text-[var(--text-color)]"
>
  <div
    class="flex flex-col gap-3 items-center w-full sm:flex-row sm:items-center sm:justify-between mb-8 mt-8 sm:mt-0"
  >
    <div class="text-center sm:text-left w-full sm:w-auto">
      <h1 class="text-2xl sm:text-3xl font-bold text-[var(--text-color)]">
        Financeiro
      </h1>
      <p class="text-base mt-1 hidden sm:block text-[var(--text-dim)]">
        Controle e registre todas as entradas e saídas financeiras.
      </p>
    </div>

    <button
      *ngIf="podeCriar()"
      (click)="abrirNovo()"
      type="button"
      [disabled]="estaCarregandoAcao || carregandoLista"
      class="flex items-center justify-center gap-2 font-semibold px-3 py-2 text-base rounded-xl shadow transition sm:px-8 sm:py-3 sm:text-lg w-auto bg-[var(--accent-yellow)] hover:brightness-110 text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 4v16m8-8H4"
        />
      </svg>
      Novo Lançamento
    </button>
  </div>

  <div class="w-full flex flex-col gap-3 mb-6">
    <div
      class="w-full flex flex-col sm:flex-row sm:items-end gap-2 sm:gap-3 justify-center"
    >
      <div class="flex flex-col w-full sm:flex-1">
        <label class="text-xs font-semibold mb-1 text-[var(--text-color)]"
          >Buscar</label
        >
        <div class="relative">
          <input
            type="text"
            inputmode="search"
            [(ngModel)]="busca"
            (ngModelChange)="onBuscarChange()"
            placeholder="Descrição ou valor (ex.: 430,00)"
            autocomplete="off"
            aria-label="Buscar por descrição ou valor"
            [disabled]="carregandoLista"
            class="w-full p-2 pr-10 rounded-lg text-sm sm:text-base outline-none transition bg-[var(--bg-color)] text-[var(--text-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
          />
          <button
            *ngIf="busca"
            (click)="busca = ''; onBuscarChange()"
            type="button"
            aria-label="Limpar busca"
            [disabled]="carregandoLista"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-[var(--text-dim)] hover:bg-[var(--table-row-hover)] hover:text-[var(--text-color)] transition disabled:opacity-50"
          >
            ✕
          </button>
        </div>
      </div>

      <div class="flex flex-col w-full sm:w-auto">
        <label class="text-xs font-semibold mb-1 text-[var(--text-color)]"
          >Tipo</label
        >
        <select
          [(ngModel)]="filtroTipo"
          (ngModelChange)="onFiltroTipoChange()"
          aria-label="Filtrar por tipo"
          [disabled]="carregandoLista"
          class="w-full sm:w-32 p-2 rounded-lg text-sm outline-none bg-[var(--bg-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
        >
          <option value="TODOS">Todos</option>
          <option value="ENTRADA">Entradas</option>
          <option value="SAIDA">Saídas</option>
        </select>
      </div>

      <div class="flex flex-col w-full sm:w-auto">
        <label class="text-xs font-semibold mb-1 text-[var(--text-color)]"
          >Data início</label
        >
        <input
          type="date"
          [(ngModel)]="dataInicio"
          (change)="onChangeData()"
          aria-label="Data de início"
          [disabled]="carregandoLista"
          class="w-full sm:w-40 px-2 sm:px-3 py-2 rounded-lg text-sm sm:text-base outline-none transition bg-[var(--bg-color)] text-[var(--text-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
        />
      </div>

      <!-- DATA FIM -->
      <div class="flex flex-col w-full sm:w-auto">
        <label class="text-xs font-semibold mb-1 text-[var(--text-color)]"
          >Data fim</label
        >
        <input
          type="date"
          [(ngModel)]="dataFim"
          (change)="onChangeData()"
          aria-label="Data de fim"
          [disabled]="carregandoLista"
          class="w-full sm:w-40 px-2 sm:px-3 py-2 rounded-lg text-sm sm:text-base outline-none transition bg-[var(--bg-color)] text-[var(--text-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
        />
      </div>
    </div>

    <!-- FILTROS RÁPIDOS -->
    <div class="flex gap-2 flex-wrap">
      <button
        type="button"
        (click)="selecionarFiltroRapido('HOJE')"
        [disabled]="carregandoLista"
        class="px-3 py-1 rounded-full text-sm border border-[var(--border-color)] bg-[var(--bg-card)] text-[var(--text-color)] hover:bg-[var(--table-row-hover)] disabled:opacity-50"
        [ngClass]="{
          '!bg-[var(--accent-yellow)] !text-black': filtroRapido === 'HOJE'
        }"
      >
        Hoje
      </button>
      <button
        type="button"
        (click)="selecionarFiltroRapido('7DIAS')"
        [disabled]="carregandoLista"
        class="px-3 py-1 rounded-full text-sm border border-[var(--border-color)] bg-[var(--bg-card)] text-[var(--text-color)] hover:bg-[var(--table-row-hover)] disabled:opacity-50"
        [ngClass]="{
          '!bg-[var(--accent-yellow)] !text-black': filtroRapido === '7DIAS'
        }"
      >
        Últimos 7 dias
      </button>
      <button
        type="button"
        (click)="selecionarFiltroRapido('MES')"
        [disabled]="carregandoLista"
        class="px-3 py-1 rounded-full text-sm border border-[var(--border-color)] bg-[var(--bg-card)] text-[var(--text-color)] hover:bg-[var(--table-row-hover)] disabled:opacity-50"
        [ngClass]="{
          '!bg-[var(--accent-yellow)] !text-black': filtroRapido === 'MES'
        }"
      >
        Mês atual
      </button>
      <button
        type="button"
        (click)="selecionarFiltroRapido('TODOS')"
        [disabled]="carregandoLista"
        class="px-3 py-1 rounded-full text-sm border border-[var(--border-color)] bg-[var(--bg-card)] text-[var(--text-color)] hover:bg-[var(--table-row-hover)] disabled:opacity-50"
        [ngClass]="{
          '!bg-[var(--accent-yellow)] !text-black': filtroRapido === 'TODOS'
        }"
      >
        Todos
      </button>
    </div>
  </div>

  <!-- TABELA + LISTA -->
  <div
    class="w-full overflow-hidden rounded-2xl shadow border bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-color)]"
  >
    <!-- TABELA DESKTOP -->
    <div class="hidden sm:block w-full">
      <table class="w-full text-[var(--text-color)]">
        <thead>
          <tr
            class="border-b-2 border-[var(--border-color)] uppercase tracking-wide text-[var(--text-color)]"
          >
            <th class="py-3.5 px-4 text-left font-semibold text-[15px]">
              Tipo
            </th>
            <th class="py-3.5 px-4 text-left font-semibold text-[15px]">
              Descrição
            </th>
            <th class="py-3.5 px-4 text-center font-semibold text-[15px]">
              Valor
            </th>
            <th class="py-3.5 px-4 text-center font-semibold text-[15px]">
              Data
            </th>
            <th class="py-3.5 px-4 text-center w-40 font-semibold text-[15px]">
              Ações
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- CARREGANDO LISTA (loader IGUAL QUARTOS) -->
          <tr *ngIf="carregandoLista">
            <td colspan="5" class="py-10 text-center text-[var(--text-dim)]">
              <div
                class="flex flex-col items-center justify-center gap-2"
                aria-live="polite"
                aria-busy="true"
              >
                <div class="relative">
                  <div
                    class="w-8 h-8 border-4 border-[var(--accent-yellow)] border-t-transparent rounded-full animate-spin"
                  ></div>
                </div>
                <p class="text-sm sm:text-base">
                  Carregando lançamentos, aguarde...
                </p>
              </div>
            </td>
          </tr>

          <ng-container *ngIf="!carregandoLista">
            <tr
              *ngFor="let l of lancamentosPaginados"
              class="transition border-b border-[var(--border-color)] odd:bg-[var(--bg-card)] even:bg-[var(--table-row-hover)] hover:bg-[var(--table-row-hover)]"
              [class.opacity-60]="l.cancelado"
            >
              <td class="py-3 px-4 text-left">
                <span
                  class="px-2.5 py-0.5 rounded-full font-semibold text-xs border"
                  [ngClass]="tipoBadgeClass(l.tipo)"
                >
                  {{ l.tipo === 'ENTRADA' ? 'Entrada' : 'Saída' }}
                </span>
              </td>

              <td class="py-3 px-4 text-left">
                <span
                  class="block max-w-xs xl:max-w-md truncate font-bold text-[15px] text-[var(--text-color)]"
                  [title]="l.descricao"
                  [class.line-through]="l.cancelado"
                >
                  {{ l.descricao }}
                </span>
                <span
                  *ngIf="l.cancelado"
                  class="text-xs text-red-400 block"
                  [title]="l.canceladoMotivo"
                >
                  Cancelado
                </span>
              </td>

              <td
                class="py-3 px-4 text-center font-bold text-[15px]"
                [ngClass]="tipoValorClass(l)"
              >
                {{
                  (isEntrada(l) ? '+' : '-') +
                    (l.valor | currency: 'BRL':'symbol':'1.2-2')
                }}
              </td>

              <td
                class="py-3 px-4 text-center font-medium text-[15px] text-[var(--text-color)]"
                [class.line-through]="l.cancelado"
              >
                {{ l.data ? (l.data | date: 'dd/MM/yyyy') : '-' }}
              </td>

              <td class="py-3 px-4">
                <div class="flex gap-2 justify-center">
                  <!-- DETALHES -->
                  <button
                    (click)="detalhes(l)"
                    type="button"
                    [disabled]="estaCarregandoAcao"
                    class="inline-flex items-center justify-center w-9 h-9 rounded-full transition hover:bg-[var(--table-row-hover)] hover:ring-2 hover:ring-blue-500 focus:ring-blue-500 focus:outline-none focus:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Detalhes"
                  >
                    <svg
                      class="w-6 h-6 sm:w-5 sm:h-5 text-blue-500"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 16v-4M12 8h.01"
                      />
                    </svg>
                  </button>

                  <!-- EDITAR -->
                  <button
                    *ngIf="podeEditar()"
                    (click)="editar(l)"
                    type="button"
                    [disabled]="l.cancelado || estaCarregandoAcao"
                    class="inline-flex items-center justify-center w-9 h-9 rounded-full transition hover:bg-[var(--table-row-hover)] hover:ring-2 hover:ring-yellow-400 focus:ring-yellow-400 focus:outline-none focus:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Editar"
                  >
                    <svg
                      class="w-6 h-6 sm:w-5 sm:h-5 text-amber-500"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L9 13z"
                      />
                    </svg>
                  </button>

                  <!-- CANCELAR -->
                  <button
                    *ngIf="podeCancelar()"
                    (click)="abrirModalCancelar(l)"
                    type="button"
                    [disabled]="l.cancelado || estaCarregandoAcao"
                    class="inline-flex items-center justify-center w-9 h-9 rounded-full transition hover:bg-[var(--table-row-hover)] hover:ring-2 hover:ring-red-500 focus:ring-red-500 focus:outline-none focus:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Cancelar Lançamento"
                  >
                      <svg
                      class="w-6 h-6 sm:w-5 sm:h-5 text-red-600"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </ng-container>

          <!-- LISTA VAZIA -->
          <tr *ngIf="!carregandoLista && (!view || view.length === 0)">
            <td colspan="5" class="py-16 text-center">
              <div
                class="flex flex-col items-center gap-3 text-[var(--text-dim)]"
              >
                <svg
                  class="w-14 h-14 mx-auto mb-3 text-[var(--border-color)]"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>

                <div class="font-semibold text-lg text-[var(--text-color)]">
                  Nenhum lançamento encontrado
                </div>
                <div class="text-sm text-[var(--text-dim)] max-w-xs">
                  Ajuste os filtros de pesquisa ou crie um novo lançamento para
                  começar.
                </div>

                <button
                  *ngIf="podeCriar()"
                  (click)="abrirNovo()"
                  type="button"
                  class="mt-3 flex items-center justify-center gap-2 font-semibold px-4 py-2 text-sm rounded-lg shadow transition bg-[var(--accent-yellow)] hover:brightness-110 text-gray-900"
                >
                  <svg
                    class="w-5 h-5 sm:w-4 sm:h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                  Criar Lançamento
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- LISTA MOBILE -->
    <div class="block sm:hidden w-full">
      <div
        class="rounded-2xl shadow p-2 bg-[var(--bg-card)] border border-[var(--border-color)] space-y-3"
      >
        <!-- CARREGANDO MOBILE -->
        <ng-container *ngIf="carregandoLista; else mobileLoaded">
          <div
            class="rounded-xl shadow-sm p-6 text-center border bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-color)]"
          >
            <div
              class="flex flex-col items-center justify-center gap-2"
              aria-live="polite"
              aria-busy="true"
            >
              <div class="relative">
                <div
                  class="w-8 h-8 border-4 border-[var(--accent-yellow)] border-t-transparent rounded-full animate-spin"
                ></div>
              </div>
              <p class="text-sm">
                Carregando lançamentos, aguarde...
              </p>
            </div>
          </div>
        </ng-container>

        <!-- CARREGADO MOBILE -->
        <ng-template #mobileLoaded>
          <ng-container
            *ngIf="
              lancamentosPaginados &&
              lancamentosPaginados.length > 0;
              else semLancamentosMobile
            "
          >
            <div
              *ngFor="let l of lancamentosPaginados"
              class="relative rounded-xl shadow-sm p-3 border bg-[var(--bg-card)] border-[var(--border-color)]"
              [class.opacity-60]="l.cancelado"
            >
              <!-- HEADER -->
              <div class="flex justify-between items-start mb-2">
                <div>
                  <span class="text-xs font-semibold uppercase text-[var(--text-dim)]">
                    {{ l.tipo === 'ENTRADA' ? 'Entrada' : 'Saída' }}
                  </span>

                  <div
                    class="text-[17px] font-bold text-[var(--text-color)] max-w-[150px] truncate"
                  >
                    {{ l.descricao }}
                  </div>

                  <div
                    class="mt-1 font-bold"
                    [ngClass]="tipoValorClass(l)"
                  >
                    {{
                      (isEntrada(l) ? '+' : '-') +
                        (l.valor | currency:'BRL':'symbol':'1.2-2')
                    }}
                  </div>
                </div>

                <div class="text-right -mr-1">
                  <span
                    class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold"
                    [ngClass]="tipoBadgeClass(l.tipo)"
                  >
                    {{ l.tipo === 'ENTRADA' ? 'Entrada' : 'Saída' }}
                  </span>
                </div>
              </div>

              <!-- DIVISOR -->
              <div
                class="border-t border-dashed border-[var(--border-color)] pt-2 flex justify-between text-xs text-[var(--text-dim)]"
              >
                <span>{{ l.data | date:'dd/MM/yyyy' }}</span>
              </div>

              <!-- AÇÕES -->
              <div class="pt-2 flex justify-end gap-1">
              <!-- DETALHES -->
<button
  (click)="detalhes(l)"
  class="inline-flex items-center justify-center w-10 h-10 rounded-full transition
         hover:bg-[var(--table-row-hover)] hover:ring-2 hover:ring-blue-500"
>
    <svg class="w-6 h-6 sm:w-5 sm:h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10"></circle>
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16v-4M12 8h.01" />
  </svg>
</button>

<!-- EDITAR -->
<button 
  *ngIf="podeEditar()"
  (click)="editar(l)"
  [disabled]="l.cancelado"
  class="inline-flex items-center justify-center w-10 h-10 rounded-full transition
         hover:bg-[var(--table-row-hover)] hover:ring-2 hover:ring-yellow-400"
>
  <svg class="w-6 h-6 sm:w-5 sm:h-5 text-amber-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L9 13z" />
  </svg>
</button>

<!-- CANCELAR -->
<button
  *ngIf="podeCancelar()"
  (click)="abrirModalCancelar(l)"
  [disabled]="l.cancelado"
  class="inline-flex items-center justify-center w-10 h-10 rounded-full transition
         hover:bg-[var(--table-row-hover)] hover:ring-2 hover:ring-red-500"
>
  <svg class="w-6 h-6 sm:w-5 sm:h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
  </svg>
</button>

              </div>
            </div>
          </ng-container>

          <!-- VAZIO MOBILE -->
          <ng-template #semLancamentosMobile>
            <div
              class="rounded-xl shadow-sm p-6 text-center border bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-color)]"
            >
              <p class="font-semibold text-lg mb-1">
                Nenhum lançamento encontrado
              </p>
              <p class="text-sm text-[var(--text-dim)]">
                Ajuste os filtros ou crie um novo lançamento.
              </p>
            </div>
          </ng-template>
        </ng-template>
      </div>
    </div>

    <!-- TOTAL DO PERÍODO -->
    <div class="flex justify-end items-center px-4 py-3 bg-[var(--bg-card)]">
      <div class="text-sm sm:text-base">
        <span class="mr-2 text-[var(--text-dim)]">Saldo do período:</span>
        <span
          class="font-bold"
          [ngClass]="{
            'text-green-500': totalAtual > 0,
            'text-red-500': totalAtual < 0,
            'text-[var(--text-color)]': totalAtual === 0
          }"
        >
          {{ totalAtual | currency: 'BRL':'symbol':'1.2-2' }}
        </span>
      </div>
    </div>
  </div>

  <!-- PAGINAÇÃO -->
  <div
    class="flex justify-center items-center mt-6 gap-4 w-full"
    *ngIf="totalPages > 1 && !carregandoLista"
  >
    <button
      type="button"
      (click)="prevPage()"
      [disabled]="page === 1"
      class="px-4 py-2 rounded-lg font-semibold disabled:opacity-50 transition bg-[var(--table-row-hover)] text-[var(--text-color)] hover:bg-[var(--border-color)]"
    >
      Anterior
    </button>

    <span class="font-semibold text-sm sm:text-base">
      Página {{ page }} de {{ totalPages }}
    </span>

    <button
      type="button"
      (click)="nextPage()"
      [disabled]="page === totalPages"
      class="px-4 py-2 rounded-lg font-semibold disabled:opacity-50 transition bg-[var(--table-row-hover)] text-[var(--text-color)] hover:bg-[var(--border-color)]"
    >
      Próxima
    </button>
  </div>

  <!-- MODAL DETALHES -->
  <div
    *ngIf="modal === 'detalhes' && selected"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm px-2"
  >
    <div
      class="relative w-full max-w-xs sm:max-w-md rounded-2xl shadow-2xl border bg-[var(--bg-card)] border-[var(--border-color)] p-6 mx-2"
    >
      <button
        (click)="fecharModal()"
        type="button"
        aria-label="Fechar"
        class="absolute top-3 right-3 p-2 rounded-full transition text-[var(--text-dim)] hover:bg-[var(--table-row-hover)] hover:text-red-500"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>

      <div class="flex items-start gap-3 mb-4">
        <div
          class="w-10 h-10 rounded-full flex items-center justify-center"
          [ngClass]="isEntrada(selected) ? 'bg-green-500/20' : 'bg-red-500/20'"
        >
          <svg
            class="w-6 h-6"
            [ngClass]="isEntrada(selected) ? 'text-green-400' : 'text-red-400'"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 16v-4M12 8h.01"
            />
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-extrabold leading-tight">
            Detalhes do Lançamento
          </h2>
          <p class="text-xs text-[var(--text-dim)] mt-1">
            Visualize os dados completos
          </p>
        </div>
      </div>

      <div class="space-y-2 text-base">
        <p><strong>Código:</strong> {{ selected.codigo || '-' }}</p>
        <p>
          <strong>Tipo: </strong>
          <span
            class="px-2.5 py-0.5 rounded-full font-semibold text-sm border"
            [ngClass]="tipoBadgeClass(selected.tipo)"
          >
            {{ selected.tipo === 'ENTRADA' ? 'Entrada' : 'Saída' }}
          </span>
        </p>
        <p><strong>Descrição:</strong> {{ selected.descricao }}</p>
        <p>
          <strong>Valor:</strong>
          <span class="font-bold" [ngClass]="tipoValorClass(selected)"
            >{{ selected.valor | currency: 'BRL' }}</span
          >
        </p>

        <p *ngIf="selected.criadoEm; else soData">
          <strong>Data e Hora:</strong>
          {{ selected.criadoEm | date: 'dd/MM/yyyy HH:mm' }}
        </p>
        <ng-template #soData>
          <p>
            <strong>Data:</strong> {{ selected.data | date: 'dd/MM/yyyy' }}
          </p>
        </ng-template>

        <p><strong>Criada por:</strong> {{ autorDa(selected) }}</p>

        <div
          *ngIf="!selected.cancelado && selected.editadoEm"
          class="mt-2 px-3 py-2 rounded-lg bg-[var(--table-row-hover)] border border-[var(--border-color)] text-sm"
        >
          <p>
            <strong>Editado por:</strong>
            {{ formatarAutor(selected.editadoPorNome, selected.editadoPorId) }}
          </p>
          <p>
            <strong>Em:</strong>
            {{ selected.editadoEm | date: 'dd/MM/yyyy HH:mm' }}
          </p>
          <p *ngIf="selected.edicoes != null">
            <strong>Edições:</strong> {{ selected.edicoes }}
          </p>
        </div>

        <ng-container *ngIf="selected.cancelado">
          <div
            class="mt-3 px-3 py-2 rounded-lg bg-red-500/10 border border-red-500/30 text-sm"
          >
            <p class="font-semibold text-red-200">Lançamento Cancelado</p>
            <p>
              Em:
              {{
                selected.canceladoEm
                  ? (selected.canceladoEm | date: 'dd/MM/yyyy HH:mm')
                  : '-'
              }}
            </p>
            <p>
              Por:
              {{
                formatarAutor(
                  selected.canceladoPorNome,
                  selected.canceladoPorId
                )
              }}
            </p>
            <p>Motivo: {{ selected.canceladoMotivo || '-' }}</p>
          </div>
        </ng-container>
      </div>

      <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
        <button
          type="button"
          (click)="gerarComprovantePdf(selected)"
          [disabled]="downloadingComprovante || estaCarregandoAcao"
          class="flex-1 px-4 py-2 rounded-xl font-semibold bg-[var(--accent-yellow)] text-black hover:brightness-110 disabled:opacity-60 flex items-center justify-center gap-2"
        >
          <ng-container *ngIf="!downloadingComprovante; else loadingPdf">
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2"
              /><path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M7 10l5 5 5-5M12 4v11"
              />
            </svg>
            Gerar PDF
          </ng-container>
          <ng-template #loadingPdf>
            <div class="flex items-center gap-2">
              <svg
                class="animate-spin w-5 h-5 text-gray-900"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span>Gerando...</span>
            </div>
          </ng-template>
        </button>
        <button
          (click)="fecharModal()"
          class="flex-1 px-5 py-2 rounded-xl font-semibold bg-[var(--table-row-hover)] hover:bg-[var(--border-color)]"
        >
          Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL NOVO / EDITAR -->
  <div
    *ngIf="modal === 'novo' || modal === 'editar'"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm px-2"
  >
    <div
      class="relative w-full max-w-xs sm:max-w-md rounded-2xl shadow-2xl border bg-[var(--bg-card)] border-[var(--border-color)] p-6 mx-2"
    >
      <button
        (click)="fecharModal()"
        type="button"
        aria-label="Fechar"
        [disabled]="estaCarregandoAcao"
        class="absolute top-3 right-3 p-2 rounded-full transition text-[var(--text-dim)] hover:bg-[var(--table-row-hover)] hover:text-red-500 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>

      <div class="flex items-start gap-3 mb-4">
        <div
          class="w-10 h-10 rounded-full bg-[var(--accent-yellow)] flex items-center justify-center text-black"
        >
          <svg
            *ngIf="modal === 'editar'"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L9 13z"
            />
          </svg>
          <svg
            *ngIf="modal !== 'editar'"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 4v16m8-8H4"
            />
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-extrabold leading-tight">
            {{ modal === 'novo' ? 'Novo Lançamento' : 'Editar Lançamento' }}
          </h2>
          <p class="text-xs text-[var(--text-dim)] mt-1">
            Preencha os campos obrigatórios e salve
          </p>
        </div>
      </div>

      <div class="space-y-3 text-base">
        <!-- TIPO -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-1">Tipo *</label>
          <select
            name="tipo"
            [(ngModel)]="form.tipo"
            [disabled]="estaCarregandoAcao"
            class="w-full p-2 rounded-lg text-sm outline-none bg-[var(--bg-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
          >
            <option value="SAIDA">Saída</option>
            <option value="ENTRADA">Entrada</option>
          </select>
        </div>

        <!-- DESCRIÇÃO -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-1">Descrição *</label>
          <input
            type="text"
            name="descricao"
            [(ngModel)]="form.descricao"
            maxlength="100"
            [disabled]="estaCarregandoAcao"
            class="w-full p-2 rounded-lg text-sm outline-none bg-[var(--bg-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
            placeholder="Ex.: Compra de material de limpeza"
          />
          <div class="text-xs text-[var(--text-dim)] mt-1 text-right">
            {{ (form.descricao || '').length }} / 100
          </div>
        </div>

        <!-- VALOR -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-1">Valor (R$) *</label>
          <input
            type="text"
            name="valor"
            [value]="valorFormatado"
            (input)="onValorInput($event)"
            (keypress)="permitirSomenteNumeros($event)"
            (paste)="onValorPaste($event)"
            maxlength="15"
            [disabled]="estaCarregandoAcao"
            class="w-full p-2 rounded-lg text-sm outline-none bg-[var(--bg-color)] border border-[var(--border-color)] focus:ring-2 focus:ring-[var(--accent-yellow)] focus:border-[var(--accent-yellow)] disabled:opacity-50"
            placeholder="0,00"
            inputmode="numeric"
            aria-label="Valor"
          />
        </div>

        <div class="text-sm text-[var(--text-dim)]">* Campos obrigatórios.</div>
      </div>

      <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
        <button
          (click)="fecharModal()"
          type="button"
          [disabled]="estaCarregandoAcao"
          class="flex-1 px-5 py-2 rounded-xl font-semibold bg-[var(--table-row-hover)] hover:bg-[var(--border-color)] disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Cancelar
        </button>
        <button
          (click)="salvar()"
          type="button"
          [disabled]="!valorValido() || !form.descricao.trim() || estaCarregandoAcao"
          class="flex-1 px-4 py-2 rounded-xl font-semibold bg-[var(--accent-yellow)] text-black hover:brightness-110 disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        >
          <ng-container *ngIf="estaCarregandoAcao">
            <svg
              class="animate-spin w-5 h-5 text-gray-900"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span>Processando...</span>
          </ng-container>
          <ng-container *ngIf="!estaCarregandoAcao">
            Salvar
          </ng-container>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL CANCELAR -->
  <div
    *ngIf="modal === 'cancelar' && selected"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm px-2"
  >
    <div
      class="relative w-full max-w-xs sm:max-w-md rounded-2xl shadow-2xl border bg-[var(--bg-card)] border-[var(--border-color)] p-6 mx-2"
    >
      <button
        (click)="fecharModal()"
        type="button"
        aria-label="Fechar"
        [disabled]="estaCarregandoAcao"
        class="absolute top-3 right-3 p-2 rounded-full transition text-[var(--text-dim)] hover:bg-[var(--table-row-hover)] hover:text-red-500 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>

      <div class="flex items-start gap-4 p-5">
        <div
          class="flex-shrink-0 w-12 h-12 rounded-full bg-red-600 text-white flex items-center justify-center"
        >
          <svg
            class="w-7 h-7"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z"
            />
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-extrabold leading-tight">
            Cancelar Lançamento
          </h2>
          <p class="text-xs text-[var(--text-dim)] mt-1">
            Tem certeza que deseja cancelar este lançamento? Esta ação marcará o
            item como "Cancelado" (soft delete) e não poderá ser desfeita.
          </p>
        </div>
      </div>

      <div class="mb-4 text-sm px-5">
        <p><strong>Descrição:</strong> {{ selected.descricao }}</p>
        <p>
          <strong>Valor:</strong>
          <span class="font-bold" [ngClass]="tipoValorClass(selected)">
            {{ selected.valor | currency: 'BRL' }}
          </span>
        </p>
        <p><strong>Data:</strong> {{ selected.data | date: 'dd/MM/yyyy' }}</p>
        <p><strong>Criada por:</strong> {{ autorDa(selected) }}</p>
      </div>

      <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6 px-5">
        <button
          (click)="fecharModal()"
          type="button"
          [disabled]="estaCarregandoAcao"
          class="flex-1 px-5 py-2 rounded-xl font-semibold bg-[var(--table-row-hover)] hover:bg-[var(--border-color)] disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Voltar
        </button>

        <button
          (click)="confirmarCancelamento()"
          type="button"
          [disabled]="estaCarregandoAcao"
          class="flex-1 px-4 py-2 rounded-xl font-semibold bg-red-500 text-white hover:bg-red-600 disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        >
          <ng-container *ngIf="estaCarregandoAcao">
            <svg
              class="animate-spin w-5 h-5 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span>Cancelando...</span>
          </ng-container>
          <ng-container *ngIf="!estaCarregandoAcao">
            Confirmar Cancelamento
          </ng-container>
        </button>
      </div>
    </div>
  </div>

  <div
    *ngIf="estaCarregandoAcao"
    class="fixed inset-0 z-40 flex items-center justify-center bg-black/40 backdrop-blur-[1px]"
  >
    <div
      class="flex items-center gap-3 px-4 py-3 rounded-2xl bg-[var(--bg-card)] border border-[var(--border-color)] shadow-2xl"
    >
      <div
        class="w-7 h-7 border-[3px] border-[var(--accent-yellow)] border-t-transparent rounded-full animate-spin"
      ></div>
      <span class="text-sm font-semibold">Processando operação...</span>
    </div>
  </div>
</div>
