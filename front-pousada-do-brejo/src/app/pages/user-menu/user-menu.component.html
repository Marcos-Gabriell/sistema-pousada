<div data-umenu-root class="relative">
  <button
    (click)="toggle()"
    class="flex items-center gap-3 rounded-xl px-3 py-2 shadow-sm border transition
           bg-[var(--bg-card)] border-[var(--border-color)]
           hover:bg-[var(--table-row-hover)]
           focus:outline-none focus:ring-2 focus:ring-[var(--accent-yellow)] focus:ring-offset-2"
    aria-haspopup="menu"
    [attr.aria-expanded]="aberto()"
  >

    <div class="flex-shrink-0">
      <div class="relative inline-block h-14 w-14 overflow-visible">
        <span
          *ngIf="unread() > 0"
          class="pointer-events-none select-none absolute top-0 right-0 translate-x-1/3 -translate-y-1/3
                 z-20 grid place-items-center rounded-full min-w-[1.4rem] h-5 px-1
                 bg-rose-600 text-white text-[10px] font-semibold leading-none
                 ring-2 ring-[var(--bg-card)] shadow-md"
        >
          {{ unread() > 9 ? '9+' : unread() }}
        </span>

        <div class="absolute inset-0 rounded-full overflow-hidden border border-[var(--border-color)] bg-[var(--bg-card)]">
          <img
            *ngIf="cachedMode() === 'PHOTO' && cachedUrl()"
            [src]="cachedUrl()!"
            alt="Avatar"
            class="h-full w-full object-cover"
            (load)="onPhotoLoad()"
            (error)="onPhotoError()"
          />

          <div
            *ngIf="cachedMode() !== 'PHOTO' || !cachedUrl()"
            class="h-full w-full grid place-items-center text-white font-semibold"
            [style.background]="cachedMode() === 'COLOR' ? cachedColor() : '#6B7A90'"
          >
            <span class="text-base font-bold tracking-wide">
              {{ iniciais() }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <span class="text-sm font-medium text-[var(--text-color)] max-w-[8rem] truncate">
        {{ me()?.nome }}
      </span>
      <svg class="h-4 w-4 text-[var(--text-dim)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/>
      </svg>
    </div>
  </button>
  <div
    *ngIf="aberto()"
    class="absolute right-0 mt-2 w-64 rounded-xl shadow-xl z-50 p-2 border
           bg-[var(--bg-card)] border-[var(--border-color)] text-[var(--text-color)]"
    role="menu"
  >
    <button
      (click)="abrirPerfil()"
      class="flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left transition
             hover:bg-[var(--table-row-hover)] focus:bg-[var(--table-row-hover)]
             focus:outline-none"
      role="menuitem"
    >
      <svg class="h-5 w-5 text-[var(--text-color)]" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.4 0-8 2.2-8 4.9V21h16v-2.1C20 16.2 16.4 14 12 14Z"/>
      </svg>
      <span class="font-medium text-[var(--text-color)]">Meu perfil</span>
    </button>

    <button
      (click)="abrirSenha()"
      class="mt-1 flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left transition
             hover:bg-[var(--table-row-hover)] focus:bg-[var(--table-row-hover)]
             focus:outline-none"
      role="menuitem"
    >
      <svg class="h-5 w-5 text-[var(--text-color)]" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 1a5 5 0 0 0-5 5v3H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-2V6a5 5 0 0 0-5-5Zm-3 8V6a3 3 0 0 1 6 0v3H9Zm3 5a2 2 0 1 1-2 2 2 2 0 0 1 2-2Z"/>
      </svg>
      <span class="font-medium text-[var(--text-color)]">Alterar senha</span>
    </button>

    <button
      (click)="abrirNotificacoes()"
      class="mt-1 flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left relative transition
             hover:bg-[var(--table-row-hover)] focus:bg-[var(--table-row-hover)]
             focus:outline-none"
      role="menuitem"
    >
      <div class="relative">
        <svg class="h-5 w-5 text-[var(--text-color)]" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2Z"/>
        </svg>

        <span
          *ngIf="unread() > 0"
          class="absolute -right-1 -top-1 min-w-[1.1rem] h-4 px-1.5 rounded-full
                 bg-rose-600 text-white text-[10px] leading-4 text-center font-semibold"
        >
          {{ unread() }}
        </span>
      </div>

      <span class="font-medium text-[var(--text-color)]">Notificações</span>
    </button>

    <div class="my-2 h-px bg-[var(--border-color)]"></div>

    <button
      (click)="abrirConfirmarLogout()"
      class="flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left transition
             hover:bg-[var(--table-row-hover)] focus:bg-[var(--table-row-hover)]
             focus:outline-none"
      role="menuitem"
    >
      <svg class="h-5 w-5 text-rose-600" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 3h9v18h-9v-2h7V5h-7V3zM4 12l5-5v3h6v4H9v3l-5-5z"/>
      </svg>
      <span class="font-medium text-rose-600">Sair</span>
    </button>
  </div>
</div>

<div *ngIf="confirmOpen()" class="fixed inset-0 z-[1000]">
  <div
    class="absolute inset-0 backdrop-blur-sm bg-black/40"
    (click)="cancelarLogout()"
  ></div>

  <div class="relative z-[1001] flex min-h-full items-center justify-center p-4">
    <div
      class="w-full max-w-sm rounded-2xl shadow-xl p-6
             bg-[var(--bg-card)] border border-[var(--border-color)]
             text-[var(--text-color)]"
      role="dialog"
      aria-labelledby="logout-title"
    >
      <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-rose-100">
        <svg class="h-6 w-6 text-rose-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      </div>

      <div class="mt-3 text-center sm:mt-5">
        <h3 id="logout-title" class="text-lg font-semibold leading-6 text-[var(--text-color)]">
          Sair da conta?
        </h3>
        <p class="mt-2 text-sm text-[var(--text-dim)]">
          Você será desconectado e precisará fazer login novamente.
        </p>
      </div>

      <div class="mt-5 sm:mt-6 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
        <button
          class="inline-flex items-center justify-center gap-2 min-w-[130px] px-4 py-2 rounded-xl text-sm font-semibold transition
                 bg-transparent text-[var(--text-color)] border border-[var(--border-color)] hover:bg-[var(--table-row-hover)]"
          (click)="cancelarLogout()"
        >
          Cancelar
        </button>

        <button
          class="inline-flex items-center justify-center gap-2 min-w-[130px] px-4 py-2 rounded-xl text-sm font-semibold text-white shadow-sm transition
                 bg-rose-600 hover:bg-rose-500"
          (click)="confirmarLogout()"
        >
          Sair
        </button>
      </div>
    </div>
  </div>
</div>
